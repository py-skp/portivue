version: "3.9"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: protivue_backend
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${PORT_BACKEND}:${PORT_BACKEND}"
    environment:
      # --- DB / App ---
      DATABASE_URL: ${DATABASE_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      SESSION_SECRET: ${SESSION_SECRET}
      PORT: ${PORT_BACKEND}

      # Web-only pod: disable scheduler here
      SCHEDULER_ENABLED: "false"

      # Gunicorn knobs
      WEB_CONCURRENCY: "2"
      WEB_THREADS: "1"
      GUNICORN_TIMEOUT: "60"

    healthcheck:
      test: [ "CMD", "curl", "-fsS", "http://localhost:${PORT_BACKEND}/health" ]
      interval: 20s
      timeout: 5s
      retries: 10

  backend-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: protivue_backend_scheduler
    restart: unless-stopped
    ports:
      - "${PORT_SCHEDULER}:${PORT_BACKEND}"
    env_file:
      - .env
    environment:
      # --- Core app ---
      DATABASE_URL: ${DATABASE_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      SESSION_SECRET: ${SESSION_SECRET}
      PORT: ${PORT_BACKEND}
      TZ: "UTC"

      # Enable the in-process APScheduler
      SCHEDULER_ENABLED: "true"

      # --- Price refresher Tuning ---
      PRICE_REFRESH_PROVIDER: "auto"
      ENABLE_YFINANCE_FALLBACK: "0"
      REFRESH_BATCH_SIZE: "5"
      REFRESH_TIME_BUDGET_SEC: "90"
      REFRESH_PER_CALL_SLEEP_SEC: "0.15"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        BACKEND_ORIGIN: ${INTERNAL_BACKEND_ORIGIN}
        NEXT_PUBLIC_BACKEND_ORIGIN: ${NEXT_PUBLIC_BACKEND_ORIGIN}
        NEXT_PUBLIC_SCHEDULER_API: ${NEXT_PUBLIC_SCHEDULER_API}
        NEXT_PUBLIC_API: ${NEXT_PUBLIC_API}
    container_name: protivue_frontend
    restart: unless-stopped
    ports:
      - "${PORT_FRONTEND}:${PORT_FRONTEND}"
    environment:
      PORT: ${PORT_FRONTEND}
      BACKEND_ORIGIN: ${INTERNAL_BACKEND_ORIGIN}
